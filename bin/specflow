#!/usr/bin/env bash
#
# specflow - TypeScript CLI for SpecFlow operations
#
# Usage: specflow <command> [options]
#
# Commands:
#   status      Get complete project status
#   next        Get next actionable task
#   mark        Mark task(s) complete/incomplete
#   check       Deep validation with auto-fix
#   init        Initialize a new SpecFlow project
#   state       Manage orchestration state
#   phase       Manage phase lifecycle (open/close/status)
#   project     Manage project lifecycle (init)
#   workflow    Execute SpecFlow skills via Claude CLI
#   templates   Manage project templates
#   help        Show this help message
#   version     Show version
#

set -euo pipefail

# Determine script directory (resolves symlinks)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")" && pwd)"
readonly SCRIPT_DIR

# Version
readonly SPECFLOW_VERSION="3.0.0"

# TypeScript CLI directory
readonly TS_CLI_DIR="${SCRIPT_DIR}/../packages/cli/dist"

# Colors
RED='\033[0;31m'
YELLOW='\033[0;33m'
RESET='\033[0m'

log_error() { echo -e "${RED}ERROR${RESET}: $*" >&2; }
log_warn() { echo -e "${YELLOW}WARN${RESET}: $*" >&2; }

# Show help
show_help() {
  cat << 'EOF'
specflow - TypeScript CLI for SpecFlow v3.0

USAGE:
    specflow <command> [options]

COMMANDS:
    status      Get complete project status for Claude orientation
                  [--json]            JSON output (default: human-readable)
                  [--quick]           Skip deep validation

    next        Get next actionable task with full context
                  [--json]            JSON output
                  [--section <name>]  Filter by section

    mark        Mark task(s) complete/incomplete
                  <task-id>           Task ID(s) to mark (T001, T001..T005, V-001)
                  [--incomplete]      Mark as incomplete
                  [--blocked <reason>] Mark as blocked
                  [--json]            JSON output

    check       Deep validation with auto-fix support
                  [--json]            JSON output
                  [--fix]             Auto-fix fixable issues
                  [--gate <gate>]     Check specific gate: design, implement, verify

    init        Initialize a new SpecFlow project (alias for "project init")
                  [--force]           Reinitialize existing project
                  [--name <name>]     Project name (default: directory name)

    project     Manage project lifecycle
                  init                Initialize a new SpecFlow project
                  [--force]           Reinitialize existing project
                  [--name <name>]     Project name (default: directory name)

    state       Manage orchestration state
                  get [key]           Get state value (dot notation)
                  set <key>=<value>   Set state value
                  init                Initialize new state
                  reset               Reset to defaults

    phase       Manage phase lifecycle
                  status              Show current phase info
                  open [number]       Start a phase (creates branch, updates state)
                  close               Close current phase (archives, updates ROADMAP)
                  [--json]            JSON output
                  [--dry-run]         Show what would happen (close only)

    workflow    Execute SpecFlow skills via Claude CLI
                  design              Run /flow.design skill
                  answer <id> <ans>   Answer a queued question
                  status              Check workflow status
                  [--json]            JSON output

    templates   Manage project templates
                  sync                Copy templates from ~/.specflow/templates
                  [--force]           Overwrite existing templates

    help        Show this help message
    version     Show version

EXAMPLES:
    specflow init                            # Initialize new project
    specflow init --name "My App"            # With custom name
    specflow status --json
    specflow next
    specflow mark T007
    specflow check --fix
    specflow state get orchestration.phase.number

INITIALIZATION SEQUENCE:
    1. specflow init                         # Create project structure (CLI)
    2. /flow.init                            # Run discovery interview (Claude Code)
    3. /flow.orchestrate                     # Start development workflow (Claude Code)

For Claude Code slash commands, use: /flow.orchestrate, /flow.design, etc.
EOF
}

# Show version
show_version() {
  echo "specflow version ${SPECFLOW_VERSION}"
}

# Execute a TypeScript CLI command
run_ts_cli() {
  local command="$1"
  shift
  local cli_path="${TS_CLI_DIR}/index.js"

  if [[ -f "${cli_path}" ]]; then
    exec node "${cli_path}" "${command}" "$@"
  else
    log_error "TypeScript CLI not built."
    log_error "Run: cd $(dirname "${SCRIPT_DIR}") && pnpm --filter @specflow/cli build"
    exit 1
  fi
}

# Show deprecated command error
deprecated_command() {
  local cmd="$1"
  log_error "Command '${cmd}' is deprecated in SpecFlow v3.0"
  echo ""
  echo "The TypeScript CLI replaces bash scripts with 5 smart commands:"
  echo "  specflow status   - Complete project status (replaces: context, doctor, detect)"
  echo "  specflow next     - Next task with context (replaces: tasks incomplete)"
  echo "  specflow mark     - Mark tasks done (replaces: tasks mark)"
  echo "  specflow check    - Validation & auto-fix (replaces: gate, reconcile)"
  echo "  specflow state    - State operations (same as before)"
  echo ""
  echo "Run 'specflow help' for usage."
  exit 1
}

# Main entry point
main() {
  # No arguments - show help
  if [[ $# -eq 0 ]]; then
    show_help
    exit 0
  fi

  local command="$1"
  shift

  case "${command}" in
    # TypeScript CLI commands
    status)
      run_ts_cli "status" "$@"
      ;;
    next)
      run_ts_cli "next" "$@"
      ;;
    mark)
      run_ts_cli "mark" "$@"
      ;;
    check)
      run_ts_cli "check" "$@"
      ;;
    init)
      run_ts_cli "init" "$@"
      ;;
    project)
      run_ts_cli "project" "$@"
      ;;
    state)
      run_ts_cli "state" "$@"
      ;;
    phase)
      run_ts_cli "phase" "$@"
      ;;
    upgrade)
      run_ts_cli "upgrade" "$@"
      ;;
    workflow)
      run_ts_cli "workflow" "$@"
      ;;
    templates)
      run_ts_cli "templates" "$@"
      ;;
    help|--help|-h)
      show_help
      exit 0
      ;;
    version|--version|-V)
      show_version
      exit 0
      ;;
    # Deprecated bash commands - fail with helpful message
    scaffold|context|ctx|feature|feat|git|roadmap|claude-md|claudemd|\
    checklist|tasks|doctor|detect|reconcile|memory|mem|\
    lessons|gate|migrate|manifest|import|pdr|issue|dashboard)
      deprecated_command "${command}"
      ;;
    # Slash commands - these are Claude Code prompts, not CLI commands
    analyze|specify|clarify|plan|implement|verify|orchestrate|constitution|start|design)
      log_error "Unknown command: ${command}"
      echo ""
      echo "'${command}' is a Claude Code slash command, not a CLI command."
      echo "In Claude Code, type: /flow.${command}"
      exit 1
      ;;
    *)
      log_error "Unknown command: ${command}"
      echo ""
      echo "Run 'specflow help' for usage information."
      exit 1
      ;;
  esac
}

main "$@"
