---
version: '1.0'
description: 'Code review findings - systematic review of SpecFlow v2.0'
created: 2026-01-11
status: approved
---

# Code Review: 2026-01-11

**Reviewed By**: Claude (via /specflow.review)
**Scope**: Full codebase
**Categories Reviewed**: 7

---

## Summary

| Category | Findings | Approved | Deferred |
|----------|----------|----------|----------|
| Best Practices | 6 | 6 | 0 |
| Refactoring | 7 | 7 | 0 |
| Hardening | 4 | 4 | 0 |
| Missing Features | 3 | 3 | 0 |
| Orphaned Code | 4 | 4 | 0 |
| Over-Engineering | 4 | 4 | 0 |
| Outdated Docs | 8 | 8 | 0 |
| **Total** | **36** | **36** | **0** |

---

## Rating Scale Reference

| Rating | Effort | Impact | Severity |
|--------|--------|--------|----------|
| 1 | Trivial (<30 min) | Minimal improvement | Suggestion |
| 2 | Small (30 min - 2 hr) | Minor improvement | Low priority |
| 3 | Moderate (2-8 hr) | Moderate improvement | Medium priority |
| 4 | Significant (1-3 days) | Significant improvement | High priority |
| 5 | Major (>3 days) | Critical improvement | Blocking issue |

---

## Approved Findings

### Best Practices (BP)

| ID | File(s) | Effort | Impact | Severity | Finding | Recommendation |
|----|---------|--------|--------|----------|---------|----------------|
| BP001 | check-prerequisites.sh:82 | 2 | 4 | 4 | Unsafe eval() pattern | Replace with safe variable assignment |
| BP002 | check-prerequisites.sh:22 | 1 | 3 | 3 | Only set -e, missing -uo pipefail | Upgrade to full strict mode |
| BP003 | specflow-state.sh:624 | 3 | 2 | 3 | jq debug leftover in production | Remove debug, simplify logic |
| BP004 | specflow-context.sh:307 | 1 | 2 | 2 | Unquoted parameter expansion | Quote ${param%suffix} |
| BP005 | specflow-roadmap.sh:743 | 1 | 1 | 2 | Magic number without context | Add comment documenting intent |
| BP006 | specflow-feature.sh:71-80 | 2 | 2 | 2 | Missing input validation error check | Ensure callers check return values |

### Refactoring (RF)

| ID | File(s) | Effort | Impact | Severity | Finding | Recommendation |
|----|---------|--------|--------|----------|---------|----------------|
| RF001 | specflow-state.sh | 4 | 3 | 3 | cmd_migrate() 395 lines, cmd_infer() 188 lines | Extract into smaller functions |
| RF002 | specflow-state.sh:604-645 | 2 | 2 | 2 | Deep nesting in registry clean (4 levels) | Simplify to single jq approach |
| RF003 | specflow-state.sh:545-645 | 2 | 2 | 2 | Duplicate registry manipulation patterns | Extract registry helpers |
| RF004 | specflow-state.sh:1318 | 2 | 2 | 2 | Complex nested conditionals for state inference | Use state machine pattern |
| RF005 | specflow-scaffold.sh:770-957 | 2 | 2 | 2 | Hardcoded path logic in scaffold | Make data-driven config |
| RF006 | Multiple scripts | 1 | 2 | 2 | Phase validation regex duplicated | Create shared validation lib |
| RF007 | specflow-import.sh | 2 | 2 | 2 | Missing error handling on external commands | Use atomic helpers |

### Hardening (HD)

| ID | File(s) | Effort | Impact | Severity | Finding | Recommendation |
|----|---------|--------|--------|----------|---------|----------------|
| HD001 | specflow-state.sh, specflow-roadmap.sh | 3 | 3 | 3 | Unvalidated user input in jq/grep expressions | Sanitize before pattern use |
| HD002 | specflow-state.sh, specflow-roadmap.sh | 2 | 2 | 3 | Missing cleanup on intermediate temp files | Add trap cleanup on error |
| HD003 | specflow-roadmap.sh | 1 | 2 | 2 | Missing validation on external dependencies | Add require_* checks |
| HD004 | specflow-roadmap.sh | 2 | 2 | 2 | Unescaped variable expansion in grep patterns | Use grep -F or escape |

### Missing Features (MF)

| ID | File(s) | Effort | Impact | Severity | Finding | Recommendation |
|----|---------|--------|--------|----------|---------|----------------|
| MF001 | specflow-roadmap.sh:626 | 1 | 3 | 3 | Placeholder goals in non-interactive insert mode | Validate non-placeholder before write |
| MF002 | specflow-gate.sh:363 | 2 | 3 | 2 | Gate only supports npm test runner | Extend to pytest, go test, bats, etc. |
| MF003 | specflow-roadmap.sh:1156 | 2 | 2 | 2 | No backlog priority tracking/sorting | Add scoring mechanism |

### Orphaned Code (OC)

| ID | File(s) | Effort | Impact | Severity | Finding | Recommendation |
|----|---------|--------|--------|----------|---------|----------------|
| OC001 | check-prerequisites.sh | 1 | 2 | 3 | Unreferenced legacy script (replaced by specflow-context.sh) | Delete both instances |
| OC002 | specflow.specify.md:57-60 | 1 | 4 | 4 | Stale reference to create-new-feature.sh | Update to specflow feature create |
| OC003 | CLAUDE.md:83 | 1 | 2 | 2 | Over-documented legacy init-*.md references | Remove legacy refs |
| OC004 | specflow-roadmap.sh | 1 | 1 | 1 | Unused helper functions (escape_for_sed, today_date) | Inline single-use utilities |

### Over-Engineering (OE)

| ID | File(s) | Effort | Impact | Severity | Finding | Recommendation |
|----|---------|--------|--------|----------|---------|----------------|
| OE001 | specflow-roadmap.sh | 3 | 2 | 2 | Excessive complexity (74 sed/awk, 29 functions, 1419 lines) | Migrate phase data to JSON state |
| OE002 | specflow-state.sh | 3 | 2 | 2 | 11 commands in one file (1607 lines) | Split into state.sh + registry.sh |
| OE003 | specflow-roadmap.sh, specflow-gate.sh | 1 | 2 | 1 | Excessive emoji handling complexity | Store status as text, convert for display |
| OE004 | specflow-gate.sh:104-123 | 1 | 1 | 1 | Parameter proliferation in check_sections() | Use validation config file |

### Outdated Docs (OD)

| ID | File(s) | Effort | Impact | Severity | Finding | Recommendation |
|----|---------|--------|--------|----------|---------|----------------|
| OD001 | README.md:3 | 1 | 2 | 2 | Badge references YOUR_USERNAME placeholder | Replace with actual repo owner |
| OD002 | README.md:29,63,326 | 1 | 3 | 3 | GitHub URLs use YOUR_USERNAME placeholder | Replace placeholder in install commands |
| OD003 | ROADMAP.md:33-40 | 1 | 2 | 2 | Status icons don't match legend (all use âœ…) | Use correct emoji per status |
| OD004 | CLAUDE.md:29-45 | 1 | 2 | 1 | Missing lib/json.sh and lib/detection.sh in diagram | Update architecture diagram |
| OD005 | specflow.specify.md:57-60 | 2 | 4 | 4 | References deleted create-new-feature.sh | Update to specflow feature create |
| OD006 | specflow.memory.md | 2 | 2 | 1 | 727-line file too dense to navigate | Split into workflow + reference docs |
| OD007 | README.md | 2 | 2 | 2 | Claims templates customizable but no instructions | Add "Customizing Templates" section |
| OD008 | README.md:328-337 | 1 | 1 | 1 | References non-existent memory subcommands | Update to actual CLI syntax |

---

## Deferred Findings

*No findings deferred - all 36 approved for implementation.*

---

## Review Constraints Applied

- Full codebase review (no incremental mode)
- Does NOT propose brand new features
- Does NOT break existing functionality without confirmation
- Focus on refinement and technical debt reduction

---

## Cross-References

- **Phase Created**: 0041 - Code Review 2026-01-11
- **ROADMAP.md**: Phase entry added
- **Backlog**: No items deferred

---

## Implementation Priority

### High Priority (Severity 4, Quick Wins)
1. BP001 - Remove unsafe eval (check-prerequisites.sh)
2. OC002, OD005 - Fix create-new-feature.sh references
3. OD002 - Replace GitHub username placeholders

### Medium Priority (Severity 3, Moderate Effort)
4. HD001 - Add input validation before jq/grep
5. BP002 - Upgrade to set -euo pipefail
6. RF001 - Break up large functions in specflow-state.sh
7. MF001 - Validate placeholder goals before write

### Lower Priority (Code Hygiene, Higher Effort)
8. RF003, RF006 - Extract helpers, shared validation
9. OE001, OE002 - Major refactoring of roadmap and state
10. Remaining documentation updates
