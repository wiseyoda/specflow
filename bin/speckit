#!/usr/bin/env bash
#
# speckit - Unified CLI for SpecKit operations
#
# Usage: speckit <command> [subcommand] [options]
#
# Commands:
#   state       State file operations (get, set, init, reset)
#   scaffold    Create project structure
#   git         Git operations (branch, commit, merge, push)
#   roadmap     ROADMAP.md operations (status, update, next)
#   claude-md   CLAUDE.md operations (update, sync)
#   checklist   Checklist status and operations
#   tasks       Task tracking operations
#   templates   Template versioning (check, update, diff)
#   doctor      Diagnostics and auto-fix
#   detect      Detect existing content and documentation
#   reconcile   Reconcile state with file system
#   help        Show this help message
#   version     Show version
#
# Examples:
#   speckit state get
#   speckit git branch create 002-flow-engine
#   speckit roadmap update 002 complete
#   speckit doctor --fix
#

set -euo pipefail

# Version
readonly SPECKIT_VERSION="1.0.0"

# Determine script directory (resolves symlinks)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")" && pwd)"
readonly SCRIPT_DIR

# Scripts directory
readonly SCRIPTS_DIR="${SCRIPT_DIR}/../scripts/bash"

# Source common library
if [[ -f "${SCRIPTS_DIR}/lib/common.sh" ]]; then
  source "${SCRIPTS_DIR}/lib/common.sh"
else
  # Minimal fallback if common.sh doesn't exist yet
  log_error() { echo "ERROR: $*" >&2; }
  log_info() { echo "$*"; }
  log_warn() { echo "WARN: $*" >&2; }
fi

# Show help
show_help() {
  cat << 'EOF'
speckit - Unified CLI for SpecKit operations

USAGE:
    speckit <command> [subcommand] [options]

COMMANDS:
    state       State file operations
                  get [key]           Show state (or specific key)
                  set <key>=<value>   Update state value
                  init                Initialize new state file
                  reset               Reset state to defaults

    scaffold    Create project structure
                  [--force]           Recreate (overwrites existing)

    git         Git operations
                  branch create <n>   Create and checkout branch
                  branch checkout <n> Checkout existing branch
                  commit <message>    Stage all and commit
                  merge <branch>      Merge branch to current
                  push                Push current branch
                  sync                Fetch all, show status

    roadmap     ROADMAP.md operations
                  status              Show all phase statuses
                  next                Get next pending phase
                  update <p> <s>      Update phase status
                  validate            Check ROADMAP.md structure

    claude-md   CLAUDE.md operations
                  update <text>       Add to Recent Changes
                  sync                Sync from ROADMAP completions

    checklist   Checklist operations
                  status [dir]        Show completion status
                  list [dir]          List all checklists
                  incomplete [dir]    List incomplete items

    tasks       Task operations
                  status [file]       Show completion status
                  incomplete [file]   List incomplete tasks
                  mark <id>           Mark task complete
                  phase-status        Status by phase

    templates   Template versioning
                  check               Check for updates
                  update [file]       Update template(s)
                  diff <file>         Show differences

    doctor      Diagnostics and fixes
                  [--fix]             Auto-fix issues
                  [--check <area>]    Check specific area

    detect      Detect existing content
                  [--check <area>]    Check specific area (system, speckit, docs, files, state)

    reconcile   Reconcile state with files
                  [--dry-run]         Preview changes only
                  [--trust-files]     Trust file system over state
                  [--trust-state]     Trust state over file system

    help        Show this help message
    version     Show version

OPTIONS:
    -h, --help      Show help for command
    --json          Output in JSON format (where supported)
    -v, --verbose   Verbose output

EXAMPLES:
    speckit state get config
    speckit git branch create 002-flow-engine
    speckit roadmap update 002 complete
    speckit checklist status
    speckit doctor --fix

For more information, see: ~/.claude/speckit-system/README.md
EOF
}

# Show version
show_version() {
  echo "speckit version ${SPECKIT_VERSION}"
}

# Execute a subcommand script
run_script() {
  local script_name="$1"
  shift
  local script_path="${SCRIPTS_DIR}/speckit-${script_name}.sh"

  if [[ -f "${script_path}" ]]; then
    exec bash "${script_path}" "$@"
  else
    log_error "Script not found: ${script_path}"
    log_error "Command '${script_name}' is not yet implemented."
    exit 1
  fi
}

# Main entry point
main() {
  # No arguments - show help
  if [[ $# -eq 0 ]]; then
    show_help
    exit 0
  fi

  local command="$1"
  shift

  case "${command}" in
    state)
      run_script "state" "$@"
      ;;
    scaffold)
      run_script "scaffold" "$@"
      ;;
    git)
      run_script "git" "$@"
      ;;
    roadmap)
      run_script "roadmap" "$@"
      ;;
    claude-md|claudemd)
      run_script "claude-md" "$@"
      ;;
    checklist)
      run_script "checklist" "$@"
      ;;
    tasks)
      run_script "tasks" "$@"
      ;;
    templates)
      run_script "templates" "$@"
      ;;
    doctor)
      run_script "doctor" "$@"
      ;;
    detect)
      run_script "detect" "$@"
      ;;
    reconcile)
      run_script "reconcile" "$@"
      ;;
    help|--help|-h)
      show_help
      exit 0
      ;;
    version|--version|-V)
      show_version
      exit 0
      ;;
    *)
      log_error "Unknown command: ${command}"
      echo ""
      echo "Run 'speckit help' for usage information."
      exit 1
      ;;
  esac
}

main "$@"
