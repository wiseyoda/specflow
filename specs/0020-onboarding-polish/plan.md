# Implementation Plan: Onboarding Polish

**Branch**: `0020-onboarding-polish` | **Date**: 2026-01-10 | **Spec**: `specs/0020-onboarding-polish/spec.md`

## Summary

Improve first-run experience by adding project type detection to scaffold, --safe preview mode, README quickstart documentation, and optimized CLI output structure.

## Technical Context

**Language/Version**: Bash 3.2+ (POSIX-compliant)
**Primary Dependencies**: jq 1.6+, git 2.x
**Storage**: JSON (orchestration-state.json), Markdown (templates)
**Testing**: bash test-runner.sh with assert functions
**Target Platform**: macOS, Linux
**Project Type**: CLI tool (single project structure)
**Performance Goals**: N/A (CLI tool, sub-second response)
**Constraints**: POSIX-compliant, no bash 4.0+ features, shellcheck clean

## Constitution Check

_GATE: Verified against constitution.md principles_

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Developer Experience First | PASS | Primary goal of this phase |
| II. POSIX-Compliant Bash | PASS | All changes use POSIX-compatible features |
| III. CLI Over Direct Edits | PASS | No direct file edits, all through CLI |
| IV. Simplicity Over Cleverness | PASS | Simple conditionals, no templating engine |
| V. Helpful Error Messages | PASS | --safe mode provides clear preview |
| VI. Graceful Degradation | PASS | Falls back to generic when type unknown |

## Project Structure

### Documentation (this feature)

```text
specs/0020-onboarding-polish/
├── spec.md              # Feature specification
├── plan.md              # This file
├── requirements.md      # Requirements checklist
├── research.md          # Detection patterns research
└── tasks.md             # Implementation tasks (generated by /specflow.tasks)
```

### Source Code Changes

```text
scripts/bash/
├── lib/
│   └── detection.sh     # NEW: Project type detection library
├── specflow-scaffold.sh  # MODIFY: Add --safe, --type, detection logic
└── specflow-doctor.sh    # MODIFY: Output optimization

templates/
├── constitution-template.md  # MODIFY: Add language-specific sections
└── tech-stack-template.md    # MODIFY: Add language-specific sections

README.md                # MODIFY: Add Quickstart section
```

**Structure Decision**: Single CLI tool - no new directories needed, modifications to existing scripts and templates.

## Complexity Tracking

No constitution violations. Implementation follows existing patterns.

## Design Decisions

### D-001: Detection Library Approach

Create a new `lib/detection.sh` library that:
- Exports a `detect_project_type()` function
- Returns one of: typescript, javascript, rust, go, python, bash, generic
- Follows existing lib pattern (guard against double-sourcing, clean functions)

### D-002: Template Customization Strategy

Rather than multiple template files per language, use marker-based sections:

```markdown
<!-- LANG:typescript -->
Content for TypeScript projects
<!-- /LANG:typescript -->

<!-- LANG:python -->
Content for Python projects
<!-- /LANG:python -->
```

A helper function `select_template_section()` extracts the appropriate section.

### D-003: --safe Implementation

`--safe` flag will:
1. Run full scaffold logic with `DRY_RUN=true` environment
2. Collect all file operations (create, modify, skip)
3. Display formatted preview without writing
4. Exit with code 0

### D-004: CLI Output Structure

Implement a `print_summary()` function pattern:
```bash
print_summary() {
  local status="$1"   # ok, warn, error
  local action="$2"   # "Created project structure"
  local detail="$3"   # "5 directories, 3 files"
  local hint="$4"     # "Run /specflow.init to start interview"

  print_status "$status" "$action"
  echo "  $detail"
  echo "  Next: $hint"
  echo "---"
}
```

## Implementation Phases

### Phase 1: Core Detection (US-001)

1. Create `lib/detection.sh` with `detect_project_type()`
2. Add detection priority logic (tsconfig > package.json > Cargo.toml, etc.)
3. Unit tests for detection function

### Phase 2: Scaffold Integration (US-001, US-002)

1. Integrate detection into `specflow-scaffold.sh`
2. Add `--safe` flag for dry-run preview
3. Add `--type` flag for explicit override
4. Update template selection based on detected type

### Phase 3: Template Updates (US-001)

1. Update `constitution-template.md` with language sections
2. Update `tech-stack-template.md` with language sections
3. Add `select_template_section()` helper function

### Phase 4: Documentation (US-003)

1. Add Quickstart section to README.md
2. Include CLI vs slash command clarification
3. Add troubleshooting tips

### Phase 5: Output Optimization (US-004)

1. Implement `print_summary()` pattern in common.sh
2. Update scaffold command output
3. Update doctor command output
4. Ensure first 3 lines are user-critical

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Detection false positives | Priority order ensures most specific wins; --type override available |
| Template syntax complexity | Simple marker-based extraction, no regex engine needed |
| POSIX compliance | Use only bash 3.2 features, validate with shellcheck |
| Existing project breakage | --safe mode lets users preview; no destructive operations |

## Testing Strategy

1. **Unit Tests**: `tests/test-detection.sh` for project type detection
2. **Integration Tests**: Scaffold in mock projects of each type
3. **Manual Verification**: Run in real Python/Rust/Go projects
