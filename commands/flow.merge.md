---
description: Complete a phase by pushing, merging to main, cleaning up branches, archiving state, and updating ROADMAP.
handoffs:
  - label: Start Next Phase
    agent: specflow.orchestrate
    prompt: Start the next phase
    send: true
  - label: View Backlog
    agent: specflow.backlog
    prompt: Triage backlog items
  - label: Continue Later
    agent: specflow.orchestrate
    prompt: Resume development workflow
---

## User Input

```text
$ARGUMENTS
```

Arguments:
- Empty or no args: Default behavior (auto-merge, delete branch)
- `--pr-only`: Create PR but don't merge (for review workflow)
- `--force`: Skip task completion check
- `--dry-run`: Show what would happen without executing
- `--next-phase`: After merge, automatically start the next phase

## Goal

Complete the current phase with a single command by:
1. Pushing the feature branch
2. Creating and merging a PR to main (or just creating PR with `--pr-only`)
3. Cleaning up the feature branch
4. Archiving orchestration state
5. Updating ROADMAP.md status to Complete
6. Displaying backlog summary

## Execution Steps

### 1. Pre-flight Checks

**1a. Parse arguments:**

```bash
# Check for flags
PR_ONLY=false
FORCE=false
DRY_RUN=false
NEXT_PHASE=false

# Parse $ARGUMENTS
```

**1b. Verify on feature branch:**

```bash
CURRENT_BRANCH=$(git branch --show-current)
if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" ]]; then
  echo "ERROR: Cannot merge from main branch"
  echo "Checkout a feature branch first: git checkout <branch>"
  exit 1
fi
```

**1c. Check for uncommitted changes:**

```bash
if ! git diff --quiet || ! git diff --staged --quiet; then
  echo "ERROR: Uncommitted changes detected"
  echo "Commit or stash changes first:"
  echo "  git add . && git commit -m 'message'"
  echo "  git stash"
  exit 1
fi
```

**1d. Verify task completion:**

```bash
# Get task status
TASK_STATUS=$(specflow tasks status --json 2>/dev/null)

if [[ -n "$TASK_STATUS" ]]; then
  INCOMPLETE=$(echo "$TASK_STATUS" | jq -r '.incomplete // 0')
  TOTAL=$(echo "$TASK_STATUS" | jq -r '.total // 0')

  if [[ "$INCOMPLETE" -gt 0 ]] && [[ "$FORCE" != "true" ]]; then
    echo "WARNING: $INCOMPLETE of $TOTAL tasks incomplete"
    echo ""
    specflow tasks incomplete
    echo ""
    echo "Options:"
    echo "  1. Complete remaining tasks before merge"
    echo "  2. Run with --force to merge anyway"

    # Ask user via AskUserQuestion
    # If they choose to abort, exit
    # If they choose to continue, proceed
  fi
fi
```

### 2. Git Push

**2a. Push current branch:**

```bash
echo "Pushing branch to origin..."
git push -u origin "$CURRENT_BRANCH"

if [[ $? -ne 0 ]]; then
  echo "ERROR: Failed to push branch"
  echo "Check your network connection and try again"
  exit 1
fi
```

### 3. Create Pull Request

**3a. Check if gh CLI available:**

```bash
if ! command -v gh &> /dev/null; then
  echo "WARNING: GitHub CLI (gh) not installed"
  echo ""
  echo "Create PR manually:"
  echo "  https://github.com/$(git remote get-url origin | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/compare/main...$CURRENT_BRANCH"
  echo ""
  echo "Then run: /specflow.merge --continue"

  # If --pr-only, exit here
  # Otherwise, wait for user to confirm PR is merged
fi
```

**3b. Create PR:**

```bash
# Get phase info from state
PHASE_NUMBER=$(specflow state get --json | jq -r '.orchestration.phase.number // ""')
PHASE_NAME=$(specflow state get --json | jq -r '.orchestration.phase.name // ""')

# Create PR
PR_URL=$(gh pr create \
  --title "Phase $PHASE_NUMBER: $PHASE_NAME" \
  --body "## Summary

Completes phase $PHASE_NUMBER ($PHASE_NAME).

## Changes

See spec and tasks in \`specs/$PHASE_NUMBER-$PHASE_NAME/\`

---
Generated by /specflow.merge" \
  --base main \
  2>&1)

if [[ $? -ne 0 ]]; then
  # Check if PR already exists
  EXISTING_PR=$(gh pr view --json url -q '.url' 2>/dev/null)
  if [[ -n "$EXISTING_PR" ]]; then
    echo "PR already exists: $EXISTING_PR"
    PR_URL="$EXISTING_PR"
  else
    echo "ERROR: Failed to create PR"
    echo "$PR_URL"
    exit 1
  fi
fi

echo "PR created: $PR_URL"
```

### 4. Pre-Merge State Recording

**CRITICAL**: Record completion state BEFORE branch operations. This ensures the dashboard shows correct state even if merge is interrupted.

**4a. Update orchestration state:**

```bash
echo "Recording completion state..."

# Mark step as complete
specflow state set "orchestration.step.current=merge" "orchestration.step.status=complete"

# Mark phase status based on USER GATE status
# Check if phase has USER GATE in ROADMAP
HAS_USER_GATE=$(specflow phase show "$PHASE_NUMBER" --json 2>/dev/null | jq -r '.verification_gate // "" | test("USER") // false')

if [[ "$HAS_USER_GATE" == "true" ]]; then
  # Don't mark complete yet - needs user verification
  specflow state set "orchestration.phase.status=awaiting_user_gate"
  echo "Phase has USER GATE - awaiting user verification after merge"
else
  specflow state set "orchestration.phase.status=complete"
fi
```

This ensures:
- Dashboard shows current state during merge
- State is preserved if merge fails
- USER GATE phases show "awaiting" instead of "complete"

### 5. Merge Pull Request (if not --pr-only)

**5a. If `--pr-only` flag, stop here:**

```bash
if [[ "$PR_ONLY" == "true" ]]; then
  echo ""
  echo "PR created but NOT merged (--pr-only mode)"
  echo "Review at: $PR_URL"
  echo ""
  echo "After review, run /specflow.merge to complete"
  exit 0
fi
```

**5b. Merge PR:**

```bash
echo "Merging PR..."
gh pr merge --squash --delete-branch

if [[ $? -ne 0 ]]; then
  echo "ERROR: Failed to merge PR"
  echo "Check for:"
  echo "  - Merge conflicts (resolve manually)"
  echo "  - Required reviews (request reviews first)"
  echo "  - Failed CI checks (fix and push)"
  exit 1
fi
```

### 6. Branch Cleanup

**6a. Checkout main and pull:**

```bash
echo "Switching to main branch..."
git checkout main
git pull origin main
```

**6b. Delete local feature branch (if it still exists):**

```bash
# gh pr merge --delete-branch handles remote, but local may remain
git branch -d "$CURRENT_BRANCH" 2>/dev/null || true
```

### 7. Archive State

**7a. Run state archive:**

```bash
echo "Archiving phase state..."
specflow state archive
```

This moves the current phase to history and resets orchestration for the next phase.

**7b. Archive phase details to HISTORY.md:**

```bash
echo "Archiving phase details..."
specflow phase archive "$PHASE_NUMBER"
```

This moves the phase's detailed content (goal, scope, deliverables, verification gate) from ROADMAP.md to `.specify/history/HISTORY.md`, keeping ROADMAP.md lightweight.

### 7.5. Extract Handoff Items

**7.5a. Scan tasks.md for deferred items:**

```bash
echo "Checking for handoff items..."

TASKS_FILE="specs/${PHASE_NUMBER}-*/tasks.md"
HANDOFF_FILE=".specify/phases/${PHASE_NUMBER}-handoff.md"

# Look for deferred/handoff sections in tasks.md
if ls $TASKS_FILE 1>/dev/null 2>&1; then
  TASKS_PATH=$(ls $TASKS_FILE | head -1)

  # Check for deferred items section (various patterns)
  if grep -qiE "(^#+.*deferred|^#+.*handoff|## Deferred Items|## Handoff)" "$TASKS_PATH"; then
    echo "Found deferred items in tasks.md"
    FOUND_DEFERRED=true
  fi
fi
```

**7.5b. Generate handoff file if deferred items exist:**

If deferred items are found, extract them and create a structured handoff file:

```bash
if [[ "$FOUND_DEFERRED" == "true" ]]; then
  # Determine next phase number
  NEXT_PHASE=$(specflow roadmap next --json 2>/dev/null | jq -r '.number // empty')

  if [[ -z "$NEXT_PHASE" ]]; then
    echo "No next phase found - handoff items will remain in tasks.md"
  else
    # Extract deferred section content
    # Use awk to capture from "Deferred" or "Handoff" header to next major section or EOF
    DEFERRED_CONTENT=$(awk '
      /^#+ *(Deferred|Handoff)/ { capture=1 }
      capture && /^#+ / && !/^#+ *(Deferred|Handoff)/ { capture=0 }
      capture { print }
    ' "$TASKS_PATH")

    if [[ -n "$DEFERRED_CONTENT" ]]; then
      # Create handoff file
      mkdir -p .specify/phases

      cat > "$HANDOFF_FILE" << HANDOFF_EOF
---
source_phase: $PHASE_NUMBER
target_phase: $NEXT_PHASE
created: $(date +%Y-%m-%d)
status: pending
---

# Handoff from Phase $PHASE_NUMBER

These items were deferred from Phase $PHASE_NUMBER and must be incorporated into Phase $NEXT_PHASE.

**IMPORTANT**: When running \`/specflow.design\` for Phase $NEXT_PHASE, these items must be:
1. Reviewed and confirmed for inclusion
2. Added to the spec's Requirements section
3. Marked as "inherited" in the requirements checklist

---

$DEFERRED_CONTENT

---

## Verification

- [ ] All deferred items reviewed
- [ ] Confirmed items added to Phase $NEXT_PHASE spec
- [ ] Rejected items documented with rationale
HANDOFF_EOF

      echo "✓ Created handoff file: $HANDOFF_FILE"
      echo ""
      echo "╔══════════════════════════════════════════════════════════════╗"
      echo "║              Handoff Items Detected                          ║"
      echo "╠══════════════════════════════════════════════════════════════╣"
      echo "║ Deferred items from Phase $PHASE_NUMBER have been extracted. ║"
      echo "║ When Phase $NEXT_PHASE is specified, these items will be     ║"
      echo "║ automatically presented for inclusion.                       ║"
      echo "║                                                              ║"
      echo "║ Review: $HANDOFF_FILE                                        ║"
      echo "╚══════════════════════════════════════════════════════════════╝"
      echo ""
    fi
  fi
fi
```

**6.5c. Add handoff file to git:**

```bash
if [[ -f "$HANDOFF_FILE" ]]; then
  git add "$HANDOFF_FILE"
  git commit -m "chore: extract handoff items from phase $PHASE_NUMBER" --allow-empty
fi
```

### 8. Update ROADMAP

**8a. Mark phase complete:**

```bash
specflow roadmap update "$PHASE_NUMBER" complete
```

### 9. Display Backlog Summary

**9a. Show backlog items:**

```bash
echo ""
echo "============================================"
echo "Phase Complete! Backlog Summary:"
echo "============================================"
echo ""

specflow roadmap backlog list

echo ""
echo "Run /specflow.roadmap backlog to triage items into future phases"
```

### 10. Start Next Phase (if --next-phase)

**10a. If `--next-phase` flag is NOT set, show next steps and exit:**

```bash
if [[ "$NEXT_PHASE" != "true" ]]; then
  echo "Run /specflow.orchestrate to start the next phase"
  echo "Or run /specflow.merge --next-phase to merge and start next phase in one command"
  exit 0
fi
```

**10b. Get next pending phase:**

```bash
echo ""
echo "Starting next phase..."

NEXT=$(specflow roadmap next --json 2>/dev/null)

if [[ -z "$NEXT" || "$NEXT" == "null" ]]; then
  echo ""
  echo "No more pending phases in ROADMAP!"
  echo "All phases complete or add new phases with: specflow roadmap add"
  exit 0
fi

NEXT_NUMBER=$(echo "$NEXT" | jq -r '.number')
NEXT_NAME=$(echo "$NEXT" | jq -r '.name')
NEXT_BRANCH="${NEXT_NUMBER}-${NEXT_NAME}"
```

**10c. Create branch and initialize state:**

```bash
echo "Creating branch: $NEXT_BRANCH"
git checkout -b "$NEXT_BRANCH"
git push -u origin "$NEXT_BRANCH"

# Initialize state for new phase (idempotent)
specflow state init --if-missing
specflow state set "orchestration.phase.number=$NEXT_NUMBER"
specflow state set "orchestration.phase.name=$NEXT_NAME"
specflow state set "orchestration.phase.branch=$NEXT_BRANCH"
specflow state set "orchestration.phase.status=in_progress"
specflow state set "orchestration.step.current=specify"
specflow state set "orchestration.step.index=0"
specflow state set "orchestration.step.status=in_progress"

# Update ROADMAP
specflow roadmap update "$NEXT_NUMBER" in_progress

echo ""
echo "============================================"
echo "Started Phase $NEXT_NUMBER: $NEXT_NAME"
echo "============================================"
echo ""
echo "Run /specflow.orchestrate to continue the workflow"
```

### 10. Dry Run Mode

If `--dry-run` is specified, display what would happen without executing:

```text
DRY RUN - Would execute:

1. Push branch: git push -u origin 0015-workflow-commands
2. Create PR: "Phase 0015: workflow-commands"
3. Merge PR: gh pr merge --squash --delete-branch
4. Checkout main: git checkout main && git pull
5. Archive state: specflow state archive
6. Archive phase details: specflow phase archive 0015
7. Extract handoff items from tasks.md (if deferred items exist)
8. Update ROADMAP: specflow roadmap update 0015 complete
9. (if --next-phase) Create branch for next phase
10. (if --next-phase) Initialize state for next phase

No changes made.
```

## Error Handling

| Error | Response |
|-------|----------|
| Not on feature branch | Show checkout instructions |
| Uncommitted changes | Show commit/stash instructions |
| Push fails | Show network troubleshooting |
| PR creation fails | Show manual PR URL |
| Merge conflict | Show resolution instructions |
| gh not installed | Show manual workflow |
| State archive fails | Show specflow doctor command |

## Output Format

**Success:**

```text
✓ Pushed branch to origin
✓ Created PR: https://github.com/org/repo/pull/123
✓ Merged PR to main
✓ Cleaned up branch
✓ Archived phase state
✓ Archived phase details to HISTORY.md
✓ Extracted handoff items to .specify/phases/0015-handoff.md
✓ Updated ROADMAP to complete

============================================
Phase Complete! Backlog Summary:
============================================

  • [Low] Parallel phase execution
  • [Low] Team collaboration

Total: 2 item(s)

╔══════════════════════════════════════════════════════════════╗
║              Handoff Items Detected                          ║
╠══════════════════════════════════════════════════════════════╣
║ 3 deferred items extracted for Phase 0020.                   ║
║ These will be presented when /specflow.design runs.           ║
║                                                              ║
║ Review: .specify/phases/0015-handoff.md                      ║
╚══════════════════════════════════════════════════════════════╝

Run /specflow.roadmap backlog to triage items
Run /specflow.orchestrate to start next phase
```

**With --next-phase:**

```text
✓ Pushed branch to origin
✓ Created PR: https://github.com/org/repo/pull/123
✓ Merged PR to main
✓ Cleaned up branch
✓ Archived phase state
✓ Archived phase details to HISTORY.md
✓ Updated ROADMAP to complete

============================================
Phase Complete! Backlog Summary:
============================================

  • [Low] Parallel phase execution

Total: 1 item(s)

Starting next phase...

✓ Created branch: 0020-next-feature
✓ Initialized state for phase 0020

============================================
Started Phase 0020: next-feature
============================================

Run /specflow.orchestrate to continue the workflow
```

**With --pr-only:**

```text
✓ Pushed branch to origin
✓ Created PR: https://github.com/org/repo/pull/123

PR created but NOT merged (--pr-only mode)
Review at: https://github.com/org/repo/pull/123

After review, run /specflow.merge to complete
```

## Context

$ARGUMENTS
